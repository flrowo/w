<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>katsudon game</title>
</head>
<style>
    :root{
        --don-color: rgb(255, 30, 0);
        --katsu-color: rgb(0, 136, 255);
    }
    *{
        margin: 0;
        overflow: hidden;
    }
    body{
        background-color: black;
    }
    .content{
        width: 500px;
        height: 400px;
        display: flex;
        flex-wrap: wrap;
        align-content: center;
        border: solid 1px white;
    }
    .playfield{
        border: solid 1px yellow;
        width: 100%;
        height: 20%;
        display: flex;
        flex-wrap: wrap;
        align-content: center;
        align-items: center;
    }

    .circle{
        width: 50px;
        height: 50px;
        border: solid 2px rgba(255, 255, 255);        
        border-radius: 50%;
        position: absolute;
        right: 0;
    }.cursor{
	    width: 55px;
        height: 55px;
        border: solid 1px rgba(255, 255, 255, 0.3);
        background-color: rgba(255, 255, 255, 0.2);
        position: absolute;
        left: 80px;
    }.don{
        background-color: var(--don-color);
    }.katsu{
        background-color: var(--katsu-color);
    }

    .feedback{
        width: 10px;
        height: 10px;
        position: absolute;
        top: 140px;
        left: 104px;
        opacity: 0.8;
    }
    .feedback_miss{
        background-color: #F00;
    }.feedback_fifty{
        background-color: #FF0;
    }.feedback_hundred{
        background-color: #0F0;
    }


    .key-overlay{
        width: 60px;
        height: 60px;
        position: absolute;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-content: center;
        left: 10px;
        border: solid 1px #FFF;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 100000;
    }.key-light{
        margin: 1px;
        width: 10px;
        height: 10px;
        background-color: rgb(0, 255, 0);
        visibility: hidden;
    }.key-don{
        background-color: var(--don-color);
    }.key-katsu{
        background-color: var(--katsu-color);
    }.key-active{
        visibility: visible;
    }
</style>
<body>
    <div class="content">
        <div class="playfield">
            <div class="key-overlay">
                <div id="key-light-D" class="key-light key-katsu key-left"></div>
                <div id="key-light-F" class="key-light key-don key-left"></div>
                <div id="key-light-J" class="key-light key-don key-right"></div>
                <div id="key-light-K" class="key-light key-katsu key-right"></div>
            </div>
            <div id="cursor" class="circle cursor"></div>
        </div>
    </div>
    <script>
        let bpm = 200;
        let mapOffset = 0;
        let startupTime;
        function getStartupTime() {
            startupTime = new Date().getTime();
        }
        function getTimeNow() {
            return (new Date().getTime() - startupTime);
        }
        getStartupTime();

        let playfield = document.getElementsByClassName("playfield")[0];
        let playfieldLength = playfield.offsetWidth;
        function appendToPlayfield(el) {
            playfield.appendChild(el);
        }
        let map = [];

        const Feedback = class{
            static count = 0;
            #id;
            // type: miss => 0; 50% => 1; 100% => 2
            constructor(type){
                this.#id = "feedback"+(++this.constructor.count);
                let typeClass = "feedback_miss";
                if(type == 0){ typeClass = "feedback_miss" }
                else if(type == 1){ typeClass = "feedback_fifty" }
                else if(type == 2){ typeClass = "feedback_hundred" }

                let feedbackDiv = document.createElement("div");
                feedbackDiv.classList.add("feedback");
                feedbackDiv.classList.add(typeClass);
                feedbackDiv.id = this.#id;
                appendToPlayfield(feedbackDiv);
                
                let instanceDiv = document.getElementById(this.#id);
                let top = window.getComputedStyle(instanceDiv).getPropertyValue("top");
                let left = window.getComputedStyle(instanceDiv).getPropertyValue("left");
                let randomLength = feedbackDiv.offsetWidth;
                instanceDiv.style.top = parseInt(top) + (Math.random()*randomLength - randomLength/2)/5 + "px";
                instanceDiv.style.left = parseInt(left) + (Math.random()*randomLength - randomLength/2) + "px";
                
                let feedbackDuration = setInterval(()=>{
                    document.getElementById(this.#id).remove();
                    clearInterval(feedbackDuration);
                }, 500);
            }
            destroy(){

            }
        }
        
        const Note = class{
            static count = 0;
            #id;
            #sv;
            #isDon;
            #hitTimeMs;

            #active = true;
            
            #noteUpdate;
            #progress = 0;
            constructor(sv, isDon, hitTimeMs) {
                let bps = bpm/60;
                this.#id = "note"+(++this.constructor.count);
                this.#sv = sv*bps;
                this.#isDon = isDon;
                this.#hitTimeMs = hitTimeMs;

                // create update loop for this note
                // remember to use z-index with the id value to place early notes on top of late notes
                let noteDiv = document.createElement("div");
                let noteType;
                noteDiv.classList.add("circle");
                if(this.#isDon == 0) noteType = "don"; else noteType = "katsu";
                noteDiv.classList.add("note");
                noteDiv.classList.add(noteType);
                noteDiv.id = this.#id;
                noteDiv.style.zIndex = 99999 - this.constructor.count;
                appendToPlayfield(noteDiv);

                // defining offsets
                let startOffset = 1000;
                if(this.#id == "note1") console.log("start: "+((this.#hitTimeMs-mapOffset)-getTimeNow()));
                let noteOffset = this.#sv*(((this.#hitTimeMs-mapOffset)-getTimeNow())/5);
                let cursorOffset = parseInt(window.getComputedStyle(document.getElementById("cursor")).getPropertyValue("left"));
                let posLeft = noteOffset + cursorOffset;

                // defining performance
                let fps = 1000;
                let intervalBetweenFrames = 1000/fps;
                
                // update function
                let hitTimeMsNow;
                this.#noteUpdate = setInterval(() => {
                    hitTimeMsNow = (this.#hitTimeMs-mapOffset)-getTimeNow();
                    if(this.#id == "note1") console.log("update: "+hitTimeMsNow);
                    if(hitTimeMsNow <= 1000){
                        // console.log("eaeeaea");
                        // console.log("perfect hit for note: "+(!this.getIsDon())? "d": "k");
                    }
                    noteDiv.style.left = posLeft+"px";
                    posLeft -= this.#sv*intervalBetweenFrames;
                    if(parseInt(noteDiv.style.left) < 0){
                        new Feedback(0);
                        this.destroy();
                    }
                }, intervalBetweenFrames);
            }
            destroy(){
                if(!this.#active) return;
                document.getElementById(this.#id).remove();
                clearInterval(this.#noteUpdate);
                this.#active = false;
            }

            isActive(){ return this.#active; }

            getId(){ return this.#id; }
            getSV(){ return this.#sv; }
            getIsDon(){ return this.#isDon; }
            getHitTimeMs(){ return this.#hitTimeMs; }
        }
        
        const KeyClass = class{
            #id;
            #letter;
            #isDon;
            #htmlElement;
            #isPressable;
            #power;
            constructor(id, letter, isDon, htmlElement) {
                this.#id = id;
                this.#letter = letter;
                this.#isDon = isDon;
                this.#htmlElement = htmlElement;

                this.#isPressable = true;
                this.#power = 0;
            }
            // power
            setPower(p){ this.#power = p; }
            getPower(){ return this.#power; }
            resetPower(){ this.#power = 10; }
            
            // id
            getId(){ return this.#id; }

            // isDon
            checkIfIsDon(){ return this.#isDon; }

            // htmlElement
            getHtmlElement(){ return this.#htmlElement; }

            // isPressable
            checkIfIsPressable(){ return this.#isPressable }
            setPressable(){ this.#isPressable = true; }
            setUnPressable(){ this.#isPressable = false; }
        }

        let KeyArray = [
            new KeyClass(68, "D", false, document.getElementById("key-light-D")),
            new KeyClass(70, "F", true, document.getElementById("key-light-F")),
            new KeyClass(74, "J", true, document.getElementById("key-light-J")),
            new KeyClass(75, "K", false, document.getElementById("key-light-K")),
        ];

        document.onkeydown = (e)=>{
            if(e.keyCode == 192 || e.keyCode == 82){
                console.log("eae");
                map.forEach(noteEl => {
                    noteEl.destroy();
                });
                getStartupTime();
                start();
            } else{
                for (let i = 0; i < KeyArray.length; i++) {
                    if(e.keyCode == KeyArray[i].getId() && KeyArray[i].checkIfIsPressable()){
                        KeyArray[i].resetPower();
                        KeyArray[i].setUnPressable();
                    }
                }
            }
        };
        document.onkeyup = (e)=>{
            for (let i = 0; i < KeyArray.length; i++) {
                if(e.keyCode == KeyArray[i].getId()){
                    KeyArray[i].setPressable();
                }
            }
        };

        function start() {
            bpm = 145;
            let sv;
            sv = 1.05;
            map.push(new Note(sv, 0, 554));
            map.push(new Note(sv, 1, 760));
            map.push(new Note(sv, 0, 864));
            map.push(new Note(sv, 1, 1381));
            map.push(new Note(sv, 0, 1588));
            map.push(new Note(sv, 1, 1691));
            map.push(new Note(sv, 0, 1795));
            map.push(new Note(sv, 0, 2002));
            map.push(new Note(sv, 1, 2209));
            map.push(new Note(sv, 0, 2347));
            map.push(new Note(sv, 1, 2485));
            map.push(new Note(sv, 0, 2622));
            map.push(new Note(sv, 0, 2829));
            map.push(new Note(sv, 1, 3036));
            map.push(new Note(sv, 0, 3174));
            map.push(new Note(sv, 1, 3243));
            map.push(new Note(sv, 0, 3312));
            map.push(new Note(sv, 0, 3381));
            map.push(new Note(sv, 1, 3450));
            map.push(new Note(sv, 0, 3554));
            map.push(new Note(sv, 1, 3657));
            sv = 1.1;
            map.push(new Note(sv, 0, 3864));
            map.push(new Note(sv, 1, 4071));
            map.push(new Note(sv, 1, 4174));
            map.push(new Note(sv, 0, 4691));
            map.push(new Note(sv, 1, 4898));
            map.push(new Note(sv, 1, 5002));
            map.push(new Note(sv, 0, 5105));
            map.push(new Note(sv, 0, 5209));
            map.push(new Note(sv, 1, 5312));
            map.push(new Note(sv, 0, 5416));
            map.push(new Note(sv, 1, 5519));
            map.push(new Note(sv, 0, 5657));
            map.push(new Note(sv, 0, 5726));
            sv = 1.09;
            map.push(new Note(sv, 0, 5795));
            sv = 1.08;
            map.push(new Note(sv, 1, 5933));
            sv = 1.07;
            map.push(new Note(sv, 0, 6071));
            sv = 1.06;
            map.push(new Note(sv, 1, 6209));
            sv = 1.05;
            map.push(new Note(sv, 0, 6347));
            sv = 1.04;
            map.push(new Note(sv, 0, 6450));
            sv = 1.03;
            map.push(new Note(sv, 1, 6554));
            sv = 1.02;
            map.push(new Note(sv, 1, 6657));
            sv = 1.01;
            map.push(new Note(sv, 0, 6760));
            map.push(new Note(sv, 0, 6967));
            sv = 1;
            map.push(new Note(sv, 1, 7174));
        }

        // function start() {
        //     bpm = 120;
        //     mapOffset = 7440;
        //     let sv;
        //     sv = 1.5;
        //     map.push(new Note(sv, 0, 8440));
        //     map.push(new Note(sv, 0, 8690));
        //     map.push(new Note(sv, 1, 8940));
        //     map.push(new Note(sv, 1, 9190));
        //     map.push(new Note(sv, 1, 9315));
        //     map.push(new Note(sv, 0, 9440));
        //     map.push(new Note(sv, 0, 9690));
        //     map.push(new Note(sv, 1, 9940));
        //     map.push(new Note(sv, 0, 10190));
        //     map.push(new Note(sv, 1, 10315));
        //     map.push(new Note(sv, 0, 10440));

        //     map.push(new Note(sv, 0, 10690));
        //     map.push(new Note(sv, 0, 10815));
        //     map.push(new Note(sv, 1, 10940));

        //     map.push(new Note(sv, 1, 11190));
        //     map.push(new Note(sv, 1, 11315));
        //     map.push(new Note(sv, 0, 11440));
        //     map.push(new Note(sv, 1, 11565));
        //     map.push(new Note(sv, 0, 11690));
        //     map.push(new Note(sv, 1, 11815));
        //     map.push(new Note(sv, 1, 11940));
        //     map.push(new Note(sv, 0, 12065));
        //     map.push(new Note(sv, 0, 12127));
        //     map.push(new Note(sv, 0, 12190));
        //     map.push(new Note(sv, 0, 12252));
        //     map.push(new Note(sv, 0, 12315));
        //     map.push(new Note(sv, 1, 12440));
        //     map.push(new Note(sv, 0, 12690));
        //     map.push(new Note(sv, 1, 12940));
        //     map.push(new Note(sv, 0, 13065));
        //     map.push(new Note(sv, 1, 13190));
        //     map.push(new Note(sv, 1, 13315));
        //     map.push(new Note(sv, 0, 13440));
        //     map.push(new Note(sv, 0, 13690));

        //     map.push(new Note(sv, 1, 13940));
        //     map.push(new Note(sv, 0, 14190));
        //     map.push(new Note(sv, 1, 14440));
        //     map.push(new Note(sv, 1, 14690));

        //     map.push(new Note(sv, 0, 14940));
        //     map.push(new Note(sv, 0, 15065));
        //     map.push(new Note(sv, 1, 15190));
        //     map.push(new Note(sv, 1, 15315));
        //     map.push(new Note(sv, 0, 15440));

        //     map.push(new Note(sv, 0, 15690));
        //     map.push(new Note(sv, 0, 15815));
        //     map.push(new Note(sv, 1, 15940));

        //     map.push(new Note(sv, 1, 16190));
        //     map.push(new Note(sv, 1, 16315));
        //     map.push(new Note(sv, 0, 16440));
        // }

        let fixedUpdate = setInterval(() => {
            for (let i = 0; i < KeyArray.length; i++) {
                if(KeyArray[i].getPower() > 0) {
                    if(!KeyArray[i].getHtmlElement().classList.contains("key-active")) {
                        KeyArray[i].getHtmlElement().classList.add("key-active");
                    }
                    KeyArray[i].setPower(KeyArray[i].getPower()-1);
                }
                else { KeyArray[i].getHtmlElement().classList.remove("key-active"); }
            }

        }, 10);

        window.addEventListener("load", start);

    </script>
</body>
</html>